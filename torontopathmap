<script type="text/javascript" src="http://cdn.mallmaverick.com/javascripts/mapsvg/jquery.js"></script>
<script type="text/javascript" src="http://cdn.mallmaverick.com/javascripts/mapsvg/raphael.js"></script>
<script type="text/javascript" src="http://cdn.mallmaverick.com/javascripts/mapsvg/jquery.mousewheel.js"></script>
<script type="text/javascript" src="http://cdn.mallmaverick.com/system/site_images/photos/000/005/107/original/mallmaverick_svgmap.js?1412885524"></script>

<div class="map_container">
    <div class="main_container">
        <h4 class="map_heading">Toronto Path Map</h4>
        <select id="store_select_container" class="form-control hidden_phone" style="max-width:300px">
            <option disabled selected>Select Store</option>
            <script id="store_select_template" type="x-tmpl-mustache/text">
                <option value='{{svgmap_region}}'>{{name}}</option>
            </script>
        </select>
        <br />
        <div id="mapsvg_store_detail" class="hidden_phone">
            <img src="http://kodekloud.s3.amazonaws.com/sites/554a79236e6f64713f000000/69e8cd982124dc73de1f5a67a627ee75/loading.gif" class="loading_icon" alt="loading icon">
        </div>
    </div>
</div>

<script>
    $(document).ready(function(){
        loadMallDataCached(renderPageData);
    });
    function drop_pin(id){
        map.marksHide();
        var coords = map.get_coords(id);
        var height = parseInt(coords["height"]);
        var width = parseInt(coords["width"]);
        var x_offset = (parseInt(width) / 2);
        var y_offset = (parseInt(height) /2);
        map.setMarks([{ xy: [coords["x"] - 46 + x_offset, coords["y"] - 110 + y_offset],
            attrs: {
                src:  'http://assets.codecloudapp.com/sites/57b7340e6e6f644972020000/image/png/1452532624000/pin_93.png'
            }
        }]);
       
        $('#btnZoomIn').click()
        $('#btnZoomIn').click()
        $('#btnZoomIn').click()
        $('#btnZoomIn').click()
        $('#btnZoomIn').click()
    }

    function init_map(reg){
        map = $('#mapsvg_store_detail').mapSvg({
            source: getSVGMapURL(),    // Path to SVG map
            colors: {stroke: '#fff', hover: '#EF4D86'},
            disableAll: true,
            regions: reg,
            tooltipsMode:'custom',
            loadingText: "loading...",
            zoom: true,
            zoomButtons: {'show': true,'location': 'right' },
            pan:true,
            panLimit:true,
            cursor:'pointer',
            responsive:true,
            zoomLimit: [0,10],
        });
        $('.loading_icon').hide()
    }
    
    function renderPageData(){
        var stores = getStoresList();
        renderStoreList('#store_select_container','#store_select_template', stores);
        regions = {};
        $.each( stores , function( key, val ) {
            if(val.svgmap_region != null && typeof(val.svgmap_region)  != 'undefined'){
                obj = {};
                if(val.store_front_url_abs.indexOf('missing.png') > -1){
                    obj["tooltip"] = "<div class='tooltip_div hidden_phone'><p class='tooltip_name text-center'>"+val.name+"</p></div>"
                }
                else{
                    obj["tooltip"] = "<div class='tooltip_div hidden_phone'><img src='" + val.store_front_url_abs + "'><p class='tooltip_name text-center'>"+val.name+"</p></div>"
                }
                obj["attr"] = {}
                regions[val.svgmap_region] = obj
            }
        });
        $('#store_select_container').change(function(e){
            drop_pin($(this).val())
        })
        init_map(regions)
    }
</script>